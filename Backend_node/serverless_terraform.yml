service: arquitectura-serverless

plugins:
  - serverless-prune-plugin
  - serverless-scriptable-plugin
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: true
  prune:
    automatic: true
    number: 5

provider:
  name: aws
  runtime: nodejs22.x
  region: us-east-1
  role: arn:aws:iam::905418104502:role/LabRole

  environment:
    USER_POOL_ID: ${env:USER_POOL_ID}
    USER_POOL_CLIENT_ID: ${env:USER_POOL_CLIENT_ID}
    USER_PREFERENCES_TABLE: UserPreferences
    USER_TOKEN_TABLE: UserCognitoToken
    API_URL: ${env:API_URL}

  logs:
    httpApi: true

  httpApi:
    cors:
      allowedOrigins: ["*"]
      allowedMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      allowedHeaders: ["*"]

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:*
        - sts:AssumeRole
      Resource:
        - arn:aws:dynamodb:us-east-1:*:table/Paciente
        - arn:aws:dynamodb:us-east-1:*:table/Agendamiento
        - arn:aws:dynamodb:us-east-1:*:table/Agendamiento/index/*
        - arn:aws:dynamodb:us-east-1:*:table/UserPreferences


functions:
  ### Simulador de base de datos
  poblarDynamo:
    handler: src/simulador.poblarDynamo
    timeout: 60
    memorySize: 1024
    environment:
      TABLE: Agendamiento
    events:
      - httpApi:
          path: /agendamiento
          method: post

  ### Cognito
  cognitoHandler:
    handler: src/handlers/auth/cognito.cognitoHandler
    events:
      - httpApi:
          method: any
          path: /auth/{proxy+}
          authorizer: none

  ### Preferencias de usuario
  preferenciaUsuarioHandler:
    handler: src/handlers/preferenciasUsuario/preferenciasUsuario.preferenciaUsuarioHandler
    events:
      - httpApi:
          path: /profile
          method: any
      - httpApi:
          path: /profile/{proxy+}
          method: any

  ### Especialidades
  getEspecialidad:
    handler: src/handlers/getEspecialidad.main
    events:
      - httpApi:
          path: /especialidades
          method: get

  ### Usuarios
  pacienteHandler:
    handler: src/handlers/usuarios/usuario.pacienteHandler
    events:
      - httpApi:
          path: /usuario
          method: any
      - httpApi:
          path: /usuario/{proxy+}
          method: any

  ### Funcionarios
  funcionarioHandler:
    handler: src/handlers/funcionarios/funcionario.funcionarioHandler
    events:
      - httpApi:
          path: /funcionario
          method: any
      - httpApi:
          path: /funcionario/{proxy+}
          method: any

  ### Boxes
  boxHandler:
    handler: src/handlers/boxes/box.boxHandler
    events:
      - httpApi:
          path: /box
          method: any
      - httpApi:
          path: /box/{proxy+}
          method: any

  ### Agendamiento General
  agendamientoHandler:
    handler: src/handlers/agendamiento/agendamiento.agendamientoHandler
    events:
      - httpApi:
          path: /agendamiento
          method: any
      - httpApi:
          path: /agendamiento/{proxy+}
          method: any

  ### Agendamiento por Especialidad
  getCountAgendamientosPorEspecialidad:
    handler: src/handlers/agendamiento/especialidad/getCountAgendamientosPorEspecialidad.main
    events:
      - httpApi:
          path: /agendamiento/especialidad/count
          method: get

  getCountAgendamientosPorEspecialidadRangoFechas:
    handler: src/handlers/agendamiento/especialidad/getCountAgendamientosPorEspecialidadRangoFechas.main
    events:
      - httpApi:
          path: /agendamiento/especialidad/count-rango
          method: get

  porcentajeDeOcupacionPorEspecialidad:
    handler: src/handlers/agendamiento/especialidad/porcentajeDeOcupacionPorEspecialidad.main
    events:
      - httpApi:
          path: /agendamiento/especialidad/porcentaje-ocupacion
          method: get

  ### Agendamiento por Fecha
  getAgendamientoEspecialidadFecha:
    handler: src/handlers/agendamiento/fechas/getAgendamientoEspecialidadFecha.main
    events:
      - httpApi:
          path: /agendamiento/fecha-especialidad
          method: get

  agendamientosPorFecha:
    handler: src/handlers/agendamiento/fechas/agendamientosPorFecha.main
    events:
      - httpApi:
          path: /agendamiento/por-fecha
          method: get

  agendamientoTotalHoyBox:
    handler: src/handlers/agendamiento/fechas/agendamientoTotalHoyBox.main
    events:
      - httpApi:
          path: /agendamiento/hoy/box
          method: get

  cantidadAgendamientosEntreFechas:
    handler: src/handlers/agendamiento/fechas/cantidadAgendamientosEntreFechas.main
    events:
      - httpApi:
          path: /agendamiento/cantidad-entre-fechas
          method: get

  ### Gestión de Agendamientos
  postAgendamientoPersonalizado:
    handler: src/handlers/agendamiento/gestion/postAgendamientoPersonalizado.main
    events:
      - httpApi:
          path: /agendamiento/personalizado
          method: post

  postAgendamientoSupremus:
    handler: src/handlers/agendamiento/gestion/postAgendamientoSupremus.main
    events:
      - httpApi:
          path: /agendamiento/supremus
          method: post

  eliminarAgendamiento:
    handler: src/handlers/agendamiento/gestion/eliminarAgendamiento.main
    events:
      - httpApi:
          path: /agendamiento
          method: delete

  ### Ocupación
  ocupacionTotalSegunDiaEntreFechas:
    handler: src/handlers/ocupacion/ocupacionTotalSegunDiaEntreFechas.main
    events:
      - httpApi:
          path: /ocupacion/ocupacion-total
          method: get

  diferenciaOcupanciaMeses:
    handler: src/handlers/ocupacion/diferenciaOcupanciaMeses.main
    events:
      - httpApi:
          path: /ocupacion/diferencia-ocupacion-meses
          method: get


package:
  individually: true
  patterns:
    - "!**/*.md"
    - "!**/*.test.*"
