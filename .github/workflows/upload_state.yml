name: Upload Terraform State (S3 + DynamoDB)

on:
  workflow_dispatch:
    inputs:
      state_bucket_name:
        description: 'Optional S3 bucket name for terraform state (if empty, generated from account and region)'
        required: false
      lock_table_name:
        description: 'Optional DynamoDB table name for locking (if empty, generated from account)'
        required: false
      state_file_path:
        description: 'Path to local terraform.tfstate file in repo'
        required: false
        default: 'Backend_node/infra/terraform.tfstate'

jobs:
  upload:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Ensure AWS CLI available
        run: aws --version

      - name: Prepare names and upload state
        run: |
          set -euo pipefail
          STATE_FILE="${{ github.event.inputs.state_file_path }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGION=${AWS_REGION:-${AWS_DEFAULT_REGION:-us-east-1}}

          if [ -n "${{ github.event.inputs.state_bucket_name }}" ]; then
            BUCKET_NAME="${{ github.event.inputs.state_bucket_name }}"
          else
            BUCKET_NAME="terraform-state-${ACCOUNT_ID}-${REGION}"
          fi

          if [ -n "${{ github.event.inputs.lock_table_name }}" ]; then
            LOCK_TABLE="${{ github.event.inputs.lock_table_name }}"
          else
            LOCK_TABLE="terraformState${ACCOUNT_ID}"
          fi

          echo "Using bucket: $BUCKET_NAME"
          echo "Using lock table: $LOCK_TABLE"

          # Create bucket if it doesn't exist
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket $BUCKET_NAME already exists or accessible"
          else
            echo "Creating bucket $BUCKET_NAME in region $REGION"
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" --create-bucket-configuration LocationConstraint=$REGION
            fi
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}' || true
            aws s3api put-public-access-block --bucket "$BUCKET_NAME" --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
          fi

          # Create DynamoDB lock table if it doesn't exist
          if aws dynamodb describe-table --table-name "$LOCK_TABLE" >/dev/null 2>&1; then
            echo "DynamoDB table $LOCK_TABLE exists"
          else
            echo "Creating DynamoDB table $LOCK_TABLE"
            aws dynamodb create-table --table-name "$LOCK_TABLE" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region "$REGION"
            aws dynamodb wait table-exists --table-name "$LOCK_TABLE" --region "$REGION"
          fi

          # Upload state file
          if [ ! -f "$STATE_FILE" ]; then
            echo "State file not found at $STATE_FILE"
            exit 1
          fi
          echo "Uploading $STATE_FILE to s3://$BUCKET_NAME/backend/terraform.tfstate"
          aws s3 cp "$STATE_FILE" "s3://$BUCKET_NAME/backend/terraform.tfstate"

          echo "Done. Please add the following repo secrets for CI if desired:"
          echo "TF_STATE_BUCKET=$BUCKET_NAME"
          echo "TF_STATE_KEY=backend/terraform.tfstate"
          echo "TF_STATE_LOCK_TABLE=$LOCK_TABLE"
